<script type="text/javascript"> 
function InternetRuntime()
{
	var BaseUrl = "http://localhost:9000";
	//var Status = ['Active', 'Background', 'Sleep'];
	var Tools = 
	{		
		isNullOrEmpty: function(arr)
		{
			return (arr == null || arr.length == 0);
		},
		
		joinParamsByAnd: function(params)
		{
			var StringArray = [];
			for (var o in params)
				StringArray.push( o + '=' + params[o]);
			return StringArray.join('&');
		}
		
		
	};
	
	
	
	this.Communication = new function()
	{
		
		
		function asyncHTTPPost(url, params, content, callbackfunc)
		{
			try
			{
				var request = new XMLHttpRequest();
				if(!Tools.isNullOrEmpty(params))
					url = url + "?" + Tools.joinParamsByAnd(params);
				request.open("POST", url, true);
				request.send(content);
				request.onreadystatechange = function()
				{
					if (request.readyState==4 && request.status==200)
					{
						if (callbackfunc)
							callbackfunc(request.responseText);				
					}
					else if (request.readyState==4 && request.status!=200)
						alert("asyncHTTPGet Error!");
				}
			}catch (e)
			{
				alert(e);
			}
		}
		
		function asyncHTTPGet(url, params, callbackfunc)
		{
			try
			{		
				var request = new XMLHttpRequest();
				if(!Tools.isNullOrEmpty(params))
					url = url + "?" + Tools.joinParamsByAnd(params);
				request.open("GET", url, true);
				request.onreadystatechange = function()
				{
					if (request.readyState==4 && request.status==200)	
					{
						if (callbackfunc)
							callbackfunc(request.responseText);				
					}
					else if (request.readyState==4 && request.status!=200)
						alert("asyncHTTPGet Error!");
				}
				request.send();
			}catch (e)
			{
				alert(e);
			}
		}
		
		function HTTPGet(url, params)
		{
			try
			{
				var request = new XMLHttpRequest();
				if(!Tools.isNullOrEmpty(params))
					url = url + "?" + Tools.joinParamsByAnd(params);
				request.open("GET", url, false);
				request.send();
				return request.responseText;
			}catch (e)
			{
				alert(e);
			}
		}
		
		
		this.login = function(username, password)
		{	
			var params = {};
			params.username = username;
			params.password = password;
			var url = BaseUrl + "/clients/login";
			var response = HTTPGet(url, params);
			var lp = new longpolling(eventHandlers);
			lp.Tick();
		}
		this.register = function(username, password)
		{
			var params = {};
			params.username = username;
			params.password = password;
			var url = BaseUrl + "/clients/register";
			var response = HTTPGet(url, params);
			if (response != '')
				alert(response);
		}
		this.initOption = function(signalname)
		{			
			var url = BaseUrl + "/signal/initOption/client/" + signalname;
			var params = {};
			params.format = 'json';
			var response = HTTPGet(url, params);
			if (response != '')
				alert(response);
		}
		function longpolling(callbackfuncsmap)
		{
			var status = 'Active';
			var cid = null;
			var url = BaseUrl+ "/clients/longpolling";
			
			this.Tick = tick;
			function tick()			
			{
				try
				{
					var params = {};
					if (cid != null)
						params.CID = cid;
					params.status = status;
					
					asyncHTTPGet(url, params, handleLongpolling);
				}
				catch (e)
				{
				alert(e);
				}
			}
			function handleLongpolling(rsp, msgId)
			{
				//alert(rsp);
				var response = eval(rsp);
			//	alert(response);
				cid = response;
				
				
				if (response.data)
					switch (response.type)
					{
					default:	callbackfuncsmap["default"](msgId, response.data);
					}
				
				if (status == 'Active' || status == 'Background')
				{
					tick();
				}
			}
		}
		var eventHandlers = 
		{
			"default": function askByPrompt(msgId, data)
			{
				var r = prompt(data,"");
				var url = BaseUrl+ "/clients/response";
				asyncHTTPPost(url, {'msgID': msgId}, r);				
			}
		}
	}
	
	window.onmessage = function(e)
	{
		MessageHandler[e.data.type](e.data);
	}
	var MessageHandler = 
	{
		login: function(data)
		{
			window.InternetRuntime.Communication.login(data.username, data.password);
		},
		register: function(data)
		{
			window.InternetRuntime.Communication.register(data.username, data.password);
		},
		initOption: function(data)
		{
			window.InternetRuntime.Communication.initOption(data.signalname);
		}
		
	}
	
	
	
	
}

window.InternetRuntime = new InternetRuntime();



function testRegister()
{
	window.InternetRuntime.Communication.register();
}
function testLogin()
{
	window.InternetRuntime.Communication.login();
}
function testHttpGet()
{
	window.InternetRuntime.Communication.HTTPGet("http://www.baidu.com");
}
</script>