<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<style type="text/css">
body.test1 {margin:20px auto;text-align:center;}
table {border:1px solid blue; width:800px;padding-left: 1cm;align=center;margin: auto;}
th,td {border:1px solid blue }
</style>
</head>
#{extends 'main.html' /}
#{set title:'Home' /}
<head>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script>
    try{
        var irturl = "http://internetrt.org:9000";
        var marketurl ="http://internetrt.org:9001";
  
        function param(obj,value){
            alert(value);
            alert(obj.html())
            if (value=="key") {
                obj.show();
                obj.val( "input new key");
            }

            else if (value=="const") {
                obj.show();
                obj.val( "input const value");
            }
            else {
                obj.val(value);
                obj.hide();
            }
            return
        }
        function addpara(obj){

            var params = $('<div><label>key</label><input type="text" name="key"></br><label>value</label></div>');

            alert(params.html());
            var select = $('<select><option value ="<var></var>">the var in the signal</option><option value ="key">new key</option><option value ="<var><ID></ID></var>">RoutingInstanceID</option><option value ="const" >Const value</option></select>');
            var input = $('<input name="value" type="text"/>');


            input.hide();
            select.change(function(){  param($(this).siblings("input[name='value']"),$(this).val())})

            $(params).append(select);
            $(params).append(input);
            $(obj).append(params);


            return obj;
        }
        $(function() {
        
           // $( ".button" ).button();
            $( "#addsignal").click(function() {
                 $("#signals")
                         .append('<div><label>Runat</label><select name="runat"><option value ="userinterface">userinterface</option><option value ="${id}">Appid</option></select></br><label>Signalname</label><input type="text" name="signalname"></div></br>'
                 );
            });
			
			$("#addrequestAccesses").click(function(){
				$("#requestAccesses").append('<input type="text" name="requestAccess" value="'+$("#newrequest").val()+'"/><br/>')
			});

            $("#addlistener").click(function() {
                var obj = $('<div name="listener"><select name="listener"><option value ="RequestListener">RequestListener</option><option value ="EventListener">EventListener</option><option value ="RequestListener">PipeListener</option></select></br><label>Description</label><input type="text" name="description"></br><label>Url</label><input type="text" name="url"></br><label>Signalname</label><input type="text" name="signalname"></br>' +
                        '<a class="button">AddPara</a></div></br>');
                alert(obj.find(".button").html());
                $(obj).find(".button").click(function(){addpara(obj);});
                $("#signalhandler") .append(obj);
            });
            
            $("#send").click(function(){

                var xml = '<?xml version="1.0" encoding="UTF-8"?>'+
                       '<Application>'+
                        '<Name>'+$("#attribute input[name='name']").val()+'</Name>'+
                        '<AppID>'+"${id}"+'</AppID>'+
                        '<AppOwner>'+$("#attribute input[name='appowner']").val()+'</AppOwner>';
                
                xml += "<AccessRequests>"
                $("#requestAccesses input[name='requestAccess']").each(function(index,Element){
                	xml+= '<AccessRequest>' + $(Element).val() + '</AccessRequest>'
                });
                xml += "</AccessRequests>"
                       
                xml += '<Signals>';
                $("#signals div").each(function(index,Element){
                    xml+='<Request runat="'+$(Element).find("select").val()+'"><Signalname>'+$(Element).find("input[name='signalname']").val()+'</Signalname><Description>Share request. Response should share the signal to somewhere.</Description><Require>Response should share the signal to somewhere</Require></Request>';
                    //eval($.get(irturl+"/signal/querydef/"+$(Element).find("input[name='signalname']").val(),{ format: "json"})).Description
                }) 
                       xml+='</Signals>'+
                        '<SignalHanlders>';
                $("#signalhandler").find('div[name="listener"]').each(function(index,ele){
                    xml+='<'+$(ele).find("select[name='listener']").val()+' type="httpget" runat="${id}">'+
                            '<Description>'+$(ele).find("input[name='description']").val() +'</Description>'+
                            '<URL id="1">'+$(ele).find("input[name='url']").val() +'</URL>'+
                            '<Adapter>'+
                            '<Signalname id="1">'+$(ele).find("input[name='signalname']").val()+'</Signalname>'+
                            '<params>';
                            $(ele).find("div").each(function(index,ele){
                                var value = $(ele).find("select").val()
								var key = $(ele).find("input[name='key']").val()
								var inputvalue = $(ele).find("input[name='value']").val()
					
								if (value=="key") { value = "<var><newkey>"+inputvalue+"</newkey></var>"   }
								else if (value=="const") { value = inputvalue	}
                                xml+= '<param><key>'+key+'</key><value>'+value+'</value></param>'
                            })
				
                    xml+='</params> '+
                            '</Adapter>'+
                            '</'+$(ele).find("select[name='listener']").val()+'>';
                    ;
                    
                })
                
                    xml+= '</SignalHanlders>'+
                '</Application>';
                alert(xml);

                $.post(marketurl+"/admincontroller/addappsavexml",{information:xml,id:"${id}",secret:"${secret}",email:$("#attribute input[name='email']").val()
                ,installUrl:$("#attribute input[name='installurl']").val(),updateurl:$("#attribute input[name='updateurl']").val()});    
                      
            })
            
        });
        
             }catch(e){
                alert(e)
             }
    </script>
</head>
<body>
<h1>Hello Admin!You can manage every appliacation here!</h1>
<h3> Your Appid:${id} ,Your Secret:${secret}</h3>

 <div>
    <div id="attribute">
        <label>Name</label> <input type="text" name="name"></br>
        <label>AppOwner</label> <input type="text" name="appowner"></br>
        <label>updateurl</label> <input type="text" name="updateurl"></br>
        <label>installurl</label> <input type="text" name="installurl"></br>
        <label>email</label> <input type="text" name="email"></br>
    </div>

    <div id="signals">

    </div>
    
    <div id="requestAccesses">
    <a class="button" id="addrequestAccesses">Add Request Accesses</a>:
    <select id="newrequest">
    <option value ="getApplications">getApplications</option>
    </select>
    </div>
    
     <a class="button" id="addsignal">Add Signal</a>
    <div id= "signalhandler">

    </div>
     <a class="button" id="addlistener">Add listener</a>
 </div>
<a class="button" id="send">Submit</a>
</body>
</html>